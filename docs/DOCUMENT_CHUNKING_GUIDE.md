# 文档分片功能使用指南

## 概述

Zen MCP Server 现在支持自动文档分片功能。当任何工具的输出超过 30,000 tokens 时，系统会自动将响应分成多个部分，让用户可以逐步查看完整内容。

## 功能特点

### 1. 自动触发
- 当工具输出超过 30,000 tokens（约 120,000 字符）时自动触发
- 无需额外配置或参数
- 适用于所有继承自 `SimpleTool` 的工具

### 2. 智能分片
- 在自然边界处分割（段落、章节）
- 保护代码块完整性
- 保持列表项完整
- 优化每个分片的大小

### 3. 用户友好
- 清晰的分片标记（Part X/Y）
- 继续阅读提示
- 分片信息元数据

## 工作原理

### Token 估算
系统使用 `1 token ≈ 4 字符` 的比例进行估算：
- 30,000 tokens ≈ 120,000 字符
- 这是一个保守的估算，确保不超过模型限制

### 分片策略
1. **检测长度**：检查输出是否超过阈值
2. **智能分割**：在合适的位置分割内容
   - 优先在章节标题处分割
   - 其次在空行处分割
   - 再次在段落结尾分割
   - 避免在代码块中间分割
3. **添加标记**：为每个分片添加头部和尾部标记

## 使用示例

### 基本使用
```bash
# 请求生成长文档
claude --mode zen-mcp chat "请生成一份详细的系统架构设计文档，包含至少 10 个章节"

# 如果响应很长，会看到：
# ============================================================
# 📄 Document Part 1/3
# ============================================================
# [文档内容...]
# ============================================================
# ➡️ Continued in Part 2/3
# ============================================================
```

### 继续阅读
当看到分片响应时，系统会提供继续选项。用户可以：
1. 查看当前分片内容
2. 使用继续选项查看下一片
3. 重复直到查看完所有分片

## 技术实现

### 核心组件

1. **DocumentChunker** (`utils/document_chunker.py`)
   - 智能文档分片算法
   - 代码块保护
   - 自然边界检测

2. **DocumentChunkMixin** (`tools/shared/document_chunk_mixin.py`)
   - 可混入的分片功能
   - 提供 `should_chunk_response()`、`create_chunked_response()` 等方法
   - 处理继续请求

3. **SimpleTool 集成** (`tools/simple/base.py`)
   - 自动检查响应长度
   - 在需要时触发分片
   - 处理分片继续状态

### 自定义阈值

工具可以通过覆盖 `get_chunk_threshold()` 方法来自定义分片阈值：

```python
class MyTool(SimpleTool):
    def get_chunk_threshold(self) -> int:
        return 20000  # 使用 20,000 tokens 作为阈值
```

## 最佳实践

### 1. 内容组织
- 使用清晰的章节结构
- 添加适当的空行分隔
- 使用 Markdown 格式

### 2. 代码块处理
- 尽量避免超长代码块
- 如果代码块必须很长，考虑分成多个较小的块
- 添加注释说明代码功能

### 3. 用户体验
- 在生成长内容前告知用户可能需要分片
- 提供内容概要或目录
- 使用清晰的章节标题

## 限制和注意事项

1. **Token 估算**
   - 使用字符数估算，可能不完全准确
   - 非英文内容可能有不同的 token 比例

2. **代码块限制**
   - 如果单个代码块超过分片大小，仍会被分割
   - 建议将超长代码块拆分为多个较小的块

3. **性能考虑**
   - 分片会增加少量处理时间
   - 多次往返可能影响用户体验

## 故障排查

### 问题：输出很长但没有触发分片
- 检查实际字符数（需要约 120,000 字符）
- 验证工具是否继承自 `SimpleTool`
- 查看日志中的 token 估算信息

### 问题：代码块被分割
- 单个代码块可能超过了分片限制
- 考虑将代码块拆分为多个部分
- 使用更小的代码示例

### 问题：分片位置不理想
- 添加更多的章节标题
- 使用空行分隔段落
- 确保内容有清晰的结构

## 总结

文档分片功能为 Zen MCP Server 提供了处理超长输出的能力，确保用户可以查看完整的响应内容，同时保持良好的用户体验。该功能自动工作，无需额外配置，为所有工具提供了统一的长文档处理方案。