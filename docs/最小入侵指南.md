åŸºäºé¡¹ç›®æ¶æ„æ–‡æ¡£ï¼Œæˆ‘å»ºè®®é‡‡ç”¨**æ¸è¿›å¼é›†æˆ**ç­–ç•¥ï¼Œå……åˆ†åˆ©ç”¨ç°æœ‰æ¶æ„ï¼Œæœ€å°åŒ–ä¾µå…¥æ€§ã€‚ä»¥ä¸‹æ˜¯å…·ä½“é›†æˆæ–¹æ¡ˆï¼š

## ğŸ“‹ é›†æˆæ–¹æ¡ˆæ¦‚è§ˆ

### 1. åˆ©ç”¨ç°æœ‰åŸºç¡€è®¾æ–½

```
ç°æœ‰ç»“æ„å¯ç›´æ¥ä½¿ç”¨ï¼š
âœ… conversation_memory.py - æ‰©å±•ä¸ºå®Œæ•´è®°å¿†ç³»ç»Ÿ
âœ… BaseTool/BaseWorkflowTool - å·²æœ‰å®Œå–„çš„å·¥å…·åŸºç±»
âœ… systemprompts/ - å­˜æ”¾æ–°å·¥å…·çš„æç¤ºè¯
âœ… config.py - æ·»åŠ å¢å¼ºåŠŸèƒ½é…ç½®
âœ… æµ‹è¯•æ¶æ„ - ä½¿ç”¨ç°æœ‰ä¸‰å±‚æµ‹è¯•ä½“ç³»
```

### 2. æœ€å°ä¾µå…¥å¼æ–‡ä»¶æ·»åŠ 

```
xtool_mcp_server/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ enhanced_memory.py      # æ–°å¢ï¼šæ‰©å±•ç°æœ‰conversation_memory
â”‚   â””â”€â”€ thinking_patterns.py    # æ–°å¢ï¼šæ€ç»´æ¨¡å¼ç®¡ç†
â”‚
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ simple/
â”‚   â”‚   â””â”€â”€ memory_manager.py   # æ–°å¢ï¼šè®°å¿†ç®¡ç†å·¥å…·
â”‚   â””â”€â”€ workflow/
â”‚       â””â”€â”€ thinking_enhanced.py # æ–°å¢ï¼š25ç§æ€ç»´æ¨¡å¼å·¥å…·
â”‚
â”œâ”€â”€ systemprompts/
â”‚   â”œâ”€â”€ memory_manager.md       # æ–°å¢ï¼šè®°å¿†å·¥å…·æç¤ºè¯
â”‚   â””â”€â”€ thinking_enhanced.md    # æ–°å¢ï¼šæ€ç»´å·¥å…·æç¤ºè¯
â”‚
â””â”€â”€ conf/
    â””â”€â”€ enhanced_features.json  # æ–°å¢ï¼šå¢å¼ºåŠŸèƒ½é…ç½®
```

## ğŸš€ å…·ä½“å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ‰©å±•ç°æœ‰çš„ conversation_memory.py

```python
# utils/enhanced_memory.py
"""æ‰©å±•ç°æœ‰å¯¹è¯è®°å¿†ç³»ç»Ÿï¼Œæ·»åŠ ä¸‰å±‚è®°å¿†å’Œæ™ºèƒ½åŠŸèƒ½"""

from utils.conversation_memory import ConversationMemory
import json
from pathlib import Path
from typing import Dict, List, Optional, Any

class EnhancedMemory(ConversationMemory):
    """æœ€å°ä¾µå…¥å¼æ‰©å±•ï¼Œå¤ç”¨ç°æœ‰å¯¹è¯ç®¡ç†åŸºç¡€"""
    
    def __init__(self):
        super().__init__()
        
        # åˆ©ç”¨ç°æœ‰çš„storage_backend
        self._init_memory_layers()
        self._init_path_intelligence()
        self._init_todo_management()
    
    def _init_memory_layers(self):
        """åœ¨ç°æœ‰åŸºç¡€ä¸Šæ·»åŠ ä¸‰å±‚è®°å¿†"""
        # å¤ç”¨çˆ¶ç±»çš„ storage å’Œ conversations
        self.memory_layers = {
            "global": {},     # è·¨é¡¹ç›®æŒä¹…åŒ–
            "project": {},    # é¡¹ç›®çº§æŒä¹…åŒ–
            "session": {}     # ä¼šè¯çº§ï¼Œå·²æœ‰conversationså¯å¤ç”¨
        }
        
        # åŠ è½½æŒä¹…åŒ–è®°å¿†
        self._load_persistent_memories()
    
    def save_memory(self, content: Any, layer: str = "session", 
                   metadata: Dict = None) -> str:
        """ä¿å­˜è®°å¿†åˆ°æŒ‡å®šå±‚çº§"""
        # å¤ç”¨çˆ¶ç±»çš„çº¿ç¨‹ç®¡ç†é€»è¾‘
        memory_id = self._generate_memory_id()
        
        # æ™ºèƒ½åˆ¤æ–­å­˜å‚¨å±‚çº§
        if metadata and "auto_layer" in metadata:
            layer = self._determine_layer(content, metadata)
        
        # å­˜å‚¨
        self.memory_layers[layer][memory_id] = {
            "content": content,
            "metadata": metadata or {},
            "timestamp": self._get_timestamp()
        }
        
        # å¦‚æœæ˜¯æŒä¹…å±‚ï¼Œä¿å­˜åˆ°ç£ç›˜
        if layer in ["global", "project"]:
            self._persist_layer(layer)
        
        return memory_id
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ–°å·¥å…·ï¼ˆéµå¾ªç°æœ‰æ¨¡å¼ï¼‰

```python
# tools/simple/memory_manager.py
"""è®°å¿†ç®¡ç†å·¥å…· - éµå¾ªç°æœ‰SimpleToolæ¨¡å¼"""

from tools.simple.base import SimpleTool
from utils.enhanced_memory import EnhancedMemory
import json

class MemoryManagerTool(SimpleTool):
    """æ™ºèƒ½è®°å¿†ç®¡ç†å·¥å…·"""
    
    def get_name(self) -> str:
        return "memory"
    
    def get_description(self) -> str:
        return "Intelligent memory management with auto-detection and learning"
    
    def get_tool_fields(self) -> dict:
        return {
            "action": {
                "type": "string",
                "description": "Action to perform",
                "enum": ["save", "recall", "analyze", "detect_env"]
            },
            "content": {
                "type": "string",
                "description": "Content to save or query"
            },
            "context": {
                "type": "object",
                "description": "Additional context"
            }
        }
    
    def get_required_fields(self) -> list[str]:
        return ["action"]
    
    async def prepare_prompt(self, request) -> str:
        """å‡†å¤‡æç¤ºè¯ - å¤ç”¨ç°æœ‰æ¨¡å¼"""
        action = request.params.get("action")
        
        if action == "save":
            return self._prepare_save_prompt(request)
        elif action == "recall":
            return self._prepare_recall_prompt(request)
        # ... å…¶ä»–åŠ¨ä½œ
        
        return f"Perform memory action: {action}"
```

### ç¬¬ä¸‰æ­¥ï¼šé›†æˆåˆ° server.pyï¼ˆæœ€å°ä¿®æ”¹ï¼‰

```python
# server.py ä¿®æ”¹å»ºè®®

# 1. åœ¨importséƒ¨åˆ†æ·»åŠ 
from utils.enhanced_memory import EnhancedMemory
from tools.simple.memory_manager import MemoryManagerTool
from tools.workflow.thinking_enhanced import ThinkingEnhancedTool

# 2. åœ¨create_tool_instanceså‡½æ•°ä¸­æ·»åŠ 
def create_tool_instances():
    """åˆ›å»ºæ‰€æœ‰å·¥å…·å®ä¾‹"""
    # ... ç°æœ‰å·¥å…· ...
    
    # æ·»åŠ æ–°å·¥å…·
    tools["memory"] = MemoryManagerTool()
    tools["thinkenhanced"] = ThinkingEnhancedTool()
    
    return tools

# 3. åœ¨serveråˆå§‹åŒ–æ—¶æ·»åŠ è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–
async def initialize():
    """åˆå§‹åŒ–æœåŠ¡å™¨"""
    # ... ç°æœ‰åˆå§‹åŒ–ä»£ç  ...
    
    # åˆå§‹åŒ–å¢å¼ºè®°å¿†ç³»ç»Ÿ
    if config.ENABLE_ENHANCED_MEMORY:
        global enhanced_memory
        enhanced_memory = EnhancedMemory()
        
        # è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
        project_root = os.getcwd()
        env_info = await enhanced_memory.detect_environment(project_root)
        logger.info(f"Environment detected: {env_info}")
        
        # è§£æTODOæ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        todo_path = Path(project_root) / "TODO.md"
        if todo_path.exists():
            await enhanced_memory.parse_todo(str(todo_path))
```

### ç¬¬å››æ­¥ï¼šåˆ©ç”¨ç°æœ‰é…ç½®ç³»ç»Ÿ

```python
# config.py æ·»åŠ é…ç½®é¡¹

# å¢å¼ºåŠŸèƒ½é…ç½®
ENABLE_ENHANCED_MEMORY = get_env_bool("ENABLE_ENHANCED_MEMORY", True)
MEMORY_STORAGE_PATH = os.getenv("MEMORY_STORAGE_PATH", ".zen_memory")
ENABLE_THINKING_MODES = get_env_bool("ENABLE_THINKING_MODES", True)
THINKING_DEFAULT_DEPTH = os.getenv("THINKING_DEFAULT_DEPTH", "medium")

# è®°å¿†ç³»ç»Ÿé…ç½®
MEMORY_CONFIG = {
    "auto_save": get_env_bool("MEMORY_AUTO_SAVE", True),
    "auto_detect_env": get_env_bool("MEMORY_AUTO_DETECT_ENV", True),
    "max_recall": int(os.getenv("MEMORY_MAX_RECALL", "10")),
    "layers": {
        "global": {"persist": True, "max_items": 10000},
        "project": {"persist": True, "max_items": 5000},
        "session": {"persist": False, "max_items": 1000}
    }
}

# æ€ç»´æ¨¡å¼é…ç½®
THINKING_CONFIG = {
    "auto_mode": get_env_bool("THINKING_AUTO_MODE", True),
    "max_modes": int(os.getenv("THINKING_MAX_MODES", "5")),
    "learn_patterns": get_env_bool("THINKING_LEARN_PATTERNS", True)
}
```

### ç¬¬äº”æ­¥ï¼šåˆ›å»ºç³»ç»Ÿæç¤ºè¯

```markdown
# systemprompts/memory_manager.md
éµå¾ªç°æœ‰æ ¼å¼...

# systemprompts/thinking_enhanced.md
éµå¾ªç°æœ‰æ ¼å¼...
```

### ç¬¬å…­æ­¥ï¼šæ·»åŠ æµ‹è¯•ï¼ˆåˆ©ç”¨ç°æœ‰æµ‹è¯•æ¶æ„ï¼‰

```python
# tests/test_memory_manager.py
"""å•å…ƒæµ‹è¯• - éµå¾ªç°æœ‰æµ‹è¯•æ¨¡å¼"""

import pytest
from tools.simple.memory_manager import MemoryManagerTool
from tools.shared.base_models import ToolRequest

class TestMemoryManager:
    def test_save_memory(self):
        tool = MemoryManagerTool()
        request = ToolRequest(
            tool="memory",
            params={
                "action": "save",
                "content": "Test memory",
                "context": {"type": "test"}
            }
        )
        # ... æµ‹è¯•é€»è¾‘
```

```python
# simulator_tests/test_enhanced_features.py
"""æ¨¡æ‹Ÿå™¨æµ‹è¯• - æµ‹è¯•å®Œæ•´å·¥ä½œæµ"""

def test_memory_workflow():
    """æµ‹è¯•è®°å¿†ç³»ç»Ÿå®Œæ•´å·¥ä½œæµ"""
    # 1. ç¯å¢ƒæ£€æµ‹
    # 2. ä¿å­˜è®°å¿†
    # 3. å¬å›è®°å¿†
    # 4. è·¨å·¥å…·ä½¿ç”¨
```

## ğŸ”§ æ™ºèƒ½æ³¨å…¥æœºåˆ¶ï¼ˆåˆ©ç”¨ç°æœ‰æ¶æ„ï¼‰

```python
# åœ¨ server.py çš„ handle_tool_call ä¸­æ·»åŠ è®°å¿†æ³¨å…¥

async def handle_tool_call(name: str, arguments: dict) -> CallToolResult:
    """å¤„ç†å·¥å…·è°ƒç”¨ - æ·»åŠ è®°å¿†ä¸Šä¸‹æ–‡æ³¨å…¥"""
    try:
        tool = tool_instances.get(name)
        if not tool:
            raise ValueError(f"Unknown tool: {name}")
        
        # æ™ºèƒ½æ³¨å…¥è®°å¿†ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if ENABLE_ENHANCED_MEMORY and hasattr(tool, 'use_memory'):
            # è·å–ç›¸å…³è®°å¿†
            relevant_memories = await enhanced_memory.recall(
                query=arguments.get("prompt", ""),
                context={"tool": name}
            )
            
            # æ³¨å…¥åˆ°å‚æ•°ï¼ˆä¸ç ´ååŸæœ‰æ¥å£ï¼‰
            arguments["_memory_context"] = {
                "memories": relevant_memories,
                "thinking_modes": enhanced_memory.get_suggested_modes()
            }
        
        # è°ƒç”¨åŸæœ‰é€»è¾‘
        request = ToolRequest(tool=name, params=arguments)
        result = await tool.run(request)
        
        # å­¦ä¹ å’Œä¿å­˜ï¼ˆå¦‚æœæˆåŠŸï¼‰
        if ENABLE_ENHANCED_MEMORY and result.status == "success":
            await enhanced_memory.learn_from_result(name, arguments, result)
        
        return result
```

## ğŸ¯ é›†æˆä¼˜åŠ¿

### 1. æœ€å°ä¾µå…¥
- ä¸ä¿®æ”¹ç°æœ‰å·¥å…·çš„æ¥å£
- å¤ç”¨ç°æœ‰åŸºç¡€è®¾æ–½
- ä¿æŒå‘åå…¼å®¹

### 2. æ¸è¿›å¼å¯ç”¨
```bash
# å¯é€‰æ‹©æ€§å¯ç”¨åŠŸèƒ½
ENABLE_ENHANCED_MEMORY=false  # å…³é—­æ—¶å®Œå…¨ä¸å½±å“ç°æœ‰åŠŸèƒ½
ENABLE_THINKING_MODES=false
```

### 3. åˆ©ç”¨ç°æœ‰ä¼˜åŠ¿
- ä½¿ç”¨ç°æœ‰çš„å¯¹è¯ç®¡ç†ç³»ç»Ÿ
- å¤ç”¨æ–‡ä»¶å¤„ç†å’Œå»é‡æœºåˆ¶
- é›†æˆåˆ°ç°æœ‰æµ‹è¯•æ¡†æ¶

### 4. éµå¾ªé¡¹ç›®è§„èŒƒ
- å·¥å…·è®¾è®¡éµå¾ªç°æœ‰æ¨¡å¼
- é…ç½®ç®¡ç†ä½¿ç”¨ config.py
- æµ‹è¯•ä½¿ç”¨ä¸‰å±‚æ¶æ„

## ğŸ“ å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€é›†æˆï¼ˆ2å¤©ï¼‰
1. åˆ›å»º `enhanced_memory.py`ï¼Œæ‰©å±•ç°æœ‰ `conversation_memory.py`
2. å®ç°åŸºæœ¬çš„ä¸‰å±‚è®°å¿†åŠŸèƒ½
3. æ·»åŠ å•å…ƒæµ‹è¯•

### Phase 2: å·¥å…·åˆ›å»ºï¼ˆ2å¤©ï¼‰
1. åˆ›å»º `memory_manager.py` å·¥å…·
2. åˆ›å»º `thinking_enhanced.py` å·¥å…·
3. ç¼–å†™ç³»ç»Ÿæç¤ºè¯

### Phase 3: æ™ºèƒ½åŠŸèƒ½ï¼ˆ2å¤©ï¼‰
1. å®ç°ç¯å¢ƒæ£€æµ‹
2. å®ç°TODOç®¡ç†
3. å®ç°æ€ç»´æ¨¡å¼å­¦ä¹ 

### Phase 4: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å¤©ï¼‰
1. æ·»åŠ æ¨¡æ‹Ÿå™¨æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–
3. æ–‡æ¡£æ›´æ–°

è¿™ç§é›†æˆæ–¹å¼èƒ½å¤Ÿï¼š
- âœ… æœ€å¤§ç¨‹åº¦å¤ç”¨ç°æœ‰ä»£ç 
- âœ… ä¿æŒæ¶æ„çš„ä¸€è‡´æ€§
- âœ… æ˜“äºç»´æŠ¤å’Œæ‰©å±•
- âœ… å¯é€‰æ‹©æ€§å¯ç”¨åŠŸèƒ½

æ‚¨è§‰å¾—è¿™ä¸ªé›†æˆæ–¹æ¡ˆå¦‚ä½•ï¼Ÿéœ€è¦æˆ‘è¯¦ç»†å±•å¼€æŸä¸ªéƒ¨åˆ†å—ï¼Ÿ